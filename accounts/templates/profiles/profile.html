{% extends 'base.html' %}

{% block title %}Perfil de {{ profile_user.username }}{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="row">
        <!-- Sidebar con info del perfil -->
        <div class="col-md-4">
            <div class="card shadow">
                <div class="card-body text-center">
                    <!-- Foto de perfil -->
                    {% if profile.profile_picture %}
                        <img src="{{ profile.profile_picture.url }}" 
                             alt="{{ profile_user.username }}" 
                             class="rounded-circle mb-3" 
                             style="width: 150px; height: 150px; object-fit: cover;">
                    {% else %}
                        <div class="rounded-circle bg-secondary d-flex align-items-center justify-content-center mx-auto mb-3" 
                             style="width: 150px; height: 150px;">
                            <span class="text-white fs-1">{{ profile_user.username|first|upper }}</span>
                        </div>
                    {% endif %}

                    <!-- Nombre de usuario -->
                    <h3>{{ profile_user.username }}</h3>
                    
                    <!-- Nombre completo -->
                    {% if profile_user.first_name or profile_user.last_name %}
                        <p class="text-muted">{{ profile_user.get_full_name }}</p>
                    {% endif %}

                    <!-- Botones de acción -->
                    {% if request.user == profile_user %}
                        <a href="{% url 'profile_edit' %}" class="btn btn-primary w-100 mt-3">
                            Editar Perfil
                        </a>
                        <a href="{% url 'seller_orders' %}" class="btn btn-success w-100 mt-2">
                            <i class="fas fa-store"></i> Mis Ventas
                        </a>
                    {% else %}
                        <!-- Botón para dejar/editar review -->
                        {% if puede_dejar_review %}
                            <a href="{% url 'crear_review' profile_user.username %}" class="btn btn-warning w-100 mt-3">
                                <i class="fas fa-star"></i> 
                                {% if mi_review %}Editar mi Review{% else %}Dejar Review{% endif %}
                            </a>
                        {% endif %}
                    {% endif %}
                </div>
            </div>

            <!-- Estadísticas de Reviews -->
            <div class="card shadow mt-3">
                <div class="card-body text-center">
                    <h5 class="card-title mb-3">Reputación</h5>
                    
                    <div class="text-warning" style="font-size: 2.5rem;">
                        {% if promedio > 0 %}
                            {% for i in "12345" %}
                                {% if forloop.counter <= promedio %}★{% else %}☆{% endif %}
                            {% endfor %}
                        {% else %}
                            ☆☆☆☆☆
                        {% endif %}
                    </div>
                    
                    <div class="mt-2">
                        {% if promedio > 0 %}
                            <h4 class="mb-0">{{ promedio }}</h4>
                            <small class="text-muted">{{ total_reviews }} review{% if total_reviews != 1 %}s{% endif %}</small>
                        {% else %}
                            <p class="text-muted mb-0">Sin calificaciones aún</p>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Información adicional -->
            <div class="card shadow mt-3">
                <div class="card-body">
                    <h5 class="card-title">Información de contacto</h5>
                    
                    {% if profile.phone %}
                        <p class="mb-2">
                            <i class="fas fa-phone"></i>
                            <strong>Teléfono:</strong> {{ profile.phone }}
                        </p>
                    {% endif %}

                    {% if profile_user.email %}
                        <p class="mb-2">
                            <i class="fas fa-envelope"></i>
                            <strong>Email:</strong> {{ profile_user.email }}
                        </p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Contenido principal -->
        <div class="col-md-8">
            <!-- Biografía -->
            {% if profile.bio %}
                <div class="card shadow mb-4">
                    <div class="card-body">
                        <h5 class="card-title">Sobre mí</h5>
                        <p class="card-text">{{ profile.bio }}</p>
                    </div>
                </div>
            {% endif %}

            <!-- Productos publicados con carrusel -->
            <div class="card shadow mb-4">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="card-title mb-0">Productos publicados</h5>
                        {% if profile_user.profile.products.all %}
                            <span class="badge bg-primary">{{ profile_user.profile.products.count }} productos</span>
                        {% endif %}
                    </div>
                    
                    {% if profile_user.profile.products.all %}
                        <!-- Carrusel de productos -->
                        <div class="products-carousel-container position-relative">
                            <button class="carousel-btn carousel-btn-left" onclick="scrollCarousel(-1)">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            
                            <div class="products-carousel" id="productsCarousel">
                                {% for product in profile_user.profile.products.all %}
                                <div class="product-card-carousel">
                                    <a href="{% url 'product_detail' product.id %}" class="text-decoration-none text-dark">
                                        <div class="card h-100 shadow-sm hover-card">
                                            {% if product.image %}
                                                <img src="{{ product.image.url }}" 
                                                     class="card-img-top" 
                                                     alt="{{ product.name }}" 
                                                     style="height: 200px; object-fit: cover;">
                                            {% else %}
                                                <div class="card-img-top bg-secondary d-flex align-items-center justify-content-center" 
                                                     style="height: 200px;">
                                                    <span class="text-white">Sin imagen</span>
                                                </div>
                                            {% endif %}
                                            <div class="card-body">
                                                <h6 class="card-title text-truncate">{{ product.name }}</h6>
                                                <p class="card-text text-muted small mb-1">{{ product.category.name }}</p>
                                                <h5 class="text-primary mb-2">${{ product.price }}</h5>
                                                <small class="text-muted">
                                                    <i class="fas fa-box"></i> Stock: {{ product.stock }}
                                                </small>
                                            </div>
                                        </div>
                                    </a>
                                </div>
                                {% endfor %}
                            </div>
                            
                            <button class="carousel-btn carousel-btn-right" onclick="scrollCarousel(1)">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                        
                        <div class="text-center mt-3">
                            <small class="text-muted">
                                <i class="fas fa-arrows-alt-h"></i> Deslizá para ver más productos
                            </small>
                        </div>
                    {% else %}
                        <div class="text-center py-4">
                            <i class="fas fa-box-open text-muted" style="font-size: 3rem;"></i>
                            <p class="text-muted mt-3">Este usuario no ha publicado productos aún.</p>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- SECCIÓN DE REVIEWS -->
            <div class="card shadow">
                <div class="card-body">
                    <h5 class="card-title mb-4">
                        <i class="fas fa-star text-warning"></i> Reviews ({{ total_reviews }})
                    </h5>

                    {% if reviews %}
                        {% for review in reviews %}
                        <div class="review-card mb-3 p-3 border rounded">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <div>
                                    <a href="{% url 'profile_view_user' review.autor.username %}" class="text-decoration-none">
                                        <strong>{{ review.autor.username }}</strong>
                                    </a>
                                    <div class="text-warning" style="font-size: 1.2rem;">
                                        {% for i in "12345" %}
                                            {% if forloop.counter <= review.calificacion %}★{% else %}☆{% endif %}
                                        {% endfor %}
                                    </div>
                                </div>
                                <small class="text-muted">{{ review.fecha_creacion|date:"d/m/Y" }}</small>
                            </div>
                            <p class="mb-0">{{ review.comentario }}</p>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="text-center py-5 text-muted">
                            <i class="fas fa-comment-slash" style="font-size: 3rem;"></i>
                            <p class="mt-3">Este usuario aún no tiene reviews.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.products-carousel-container {
    position: relative;
    padding: 0 50px;
}

.products-carousel {
    display: flex;
    overflow-x: auto;
    scroll-behavior: smooth;
    gap: 20px;
    padding: 10px 0;
    scrollbar-width: none;
    -ms-overflow-style: none;
}

.products-carousel::-webkit-scrollbar {
    display: none;
}

.product-card-carousel {
    flex: 0 0 280px;
    min-width: 280px;
}

.hover-card {
    transition: all 0.3s ease;
    border: 1px solid #e0e0e0;
}

.hover-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 20px rgba(74, 144, 226, 0.2) !important;
}

.carousel-btn {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    background: linear-gradient(135deg, #4A90E2, #2C5AA0);
    color: white;
    border: none;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    cursor: pointer;
    z-index: 10;
    box-shadow: 0 4px 12px rgba(74, 144, 226, 0.3);
    transition: all 0.3s;
}

.carousel-btn:hover {
    transform: translateY(-50%) scale(1.1);
    box-shadow: 0 6px 16px rgba(74, 144, 226, 0.4);
}

.carousel-btn-left {
    left: 0;
}

.carousel-btn-right {
    right: 0;
}

.carousel-btn i {
    font-size: 1.2rem;
}

.review-card {
    background-color: #f8f9fa;
    transition: all 0.2s;
}

.review-card:hover {
    background-color: #e9ecef;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

@media (max-width: 768px) {
    .products-carousel-container {
        padding: 0 35px;
    }
    
    .product-card-carousel {
        flex: 0 0 220px;
        min-width: 220px;
    }
    
    .carousel-btn {
        width: 35px;
        height: 35px;
    }
    
    .carousel-btn i {
        font-size: 1rem;
    }
}
</style>

<script>
function scrollCarousel(direction) {
    const carousel = document.getElementById('productsCarousel');
    const scrollAmount = 300;
    
    if (direction === 1) {
        carousel.scrollLeft += scrollAmount;
    } else {
        carousel.scrollLeft -= scrollAmount;
    }
}

document.addEventListener('DOMContentLoaded', function() {
    const carousel = document.getElementById('productsCarousel');
    if (!carousel) return;
    
    let isDown = false;
    let startX;
    let scrollLeft;

    carousel.addEventListener('mousedown', (e) => {
        isDown = true;
        carousel.style.cursor = 'grabbing';
        startX = e.pageX - carousel.offsetLeft;
        scrollLeft = carousel.scrollLeft;
    });

    carousel.addEventListener('mouseleave', () => {
        isDown = false;
        carousel.style.cursor = 'grab';
    });

    carousel.addEventListener('mouseup', () => {
        isDown = false;
        carousel.style.cursor = 'grab';
    });

    carousel.addEventListener('mousemove', (e) => {
        if (!isDown) return;
        e.preventDefault();
        const x = e.pageX - carousel.offsetLeft;
        const walk = (x - startX) * 2;
        carousel.scrollLeft = scrollLeft - walk;
    });
    
    carousel.style.cursor = 'grab';
});
</script>
{% endblock %}