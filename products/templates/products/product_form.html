{% extends 'base.html' %}

{% block title %}Agregar Producto{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <h1 class="my-4">Agregar Nuevo Producto</h1>
            
            <form method="post" enctype="multipart/form-data" id="formProducto">
                {% csrf_token %}
                
                <div class="mb-3">
                    <label for="name" class="form-label">Nombre</label>
                    <input type="text" class="form-control" id="name" name="name" required maxlength="50">
                </div>

                <div class="mb-3">
                    <label for="category" class="form-label">Categoría</label>
                    <select class="form-control" id="category" name="category" required>
                        <option value="">Selecciona una categoría</option>
                        {% for category in categories %}
                            <option value="{{ category.id }}">{{ category.name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="mb-3">
                    <label for="description" class="form-label">Descripción</label>
                    <textarea class="form-control" id="description" name="description" rows="4"></textarea>
                </div>

                <!-- TIPO DE VENTA -->
                <div class="mb-4">
                    <label class="form-label d-block">
                        <strong>Tipo de transacción</strong>
                    </label>
                    <div class="card">
                        <div class="card-body">
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="radio" name="tipo_venta" 
                                       id="tipo_venta" value="venta" checked>
                                <label class="form-check-label" for="tipo_venta">
                                    <strong><i class="fas fa-dollar-sign text-success"></i> Solo Venta</strong>
                                    <small class="d-block text-muted">El producto solo estará disponible para compra</small>
                                </label>
                            </div>
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="radio" name="tipo_venta" 
                                       id="tipo_intercambio" value="intercambio">
                                <label class="form-check-label" for="tipo_intercambio">
                                    <strong><i class="fas fa-exchange-alt text-info"></i> Solo Intercambio</strong>
                                    <small class="d-block text-muted">El producto solo estará disponible para intercambio (no se mostrará el precio)</small>
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="tipo_venta" 
                                       id="tipo_ambos" value="ambos">
                                <label class="form-check-label" for="tipo_ambos">
                                    <strong><i class="fas fa-arrows-alt-h text-primary"></i> Venta o Intercambio</strong>
                                    <small class="d-block text-muted">El producto estará disponible para ambas opciones</small>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mb-3" id="precio-container">
                    <label for="price" class="form-label">Precio</label>
                    <div class="input-group">
                        <span class="input-group-text">$</span>
                        <input type="number" class="form-control" id="price" name="price" 
                            step="0.01" value="0">
                    </div>
                    <small class="text-muted">Precio sugerido para venta o referencia</small>
                </div>

                <div class="mb-3">
                    <label for="stock" class="form-label">Stock</label>
                    <input type="number" class="form-control" id="stock" name="stock" value="1" required>
                </div>

                <div class="mb-3">
                    <label for="brand" class="form-label">Marca</label>
                    <input type="text" class="form-control" id="brand" name="brand" maxlength="50" value="Genérico">
                </div>

                <div class="mb-3">
                    <label for="image" class="form-label">Imagen</label>
                    <input type="file" class="form-control" id="image" name="image" accept="image/*">
                </div>

                <div class="d-flex gap-2">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Guardar Producto
                    </button>
                    <a href="{% url 'product_list' %}" class="btn btn-secondary">Cancelar</a>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal de advertencia -->
<div class="modal fade" id="modalAdvertenciaIntercambio" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, #ffc107, #ff9800);">
                <h5 class="modal-title text-white">
                    <i class="fas fa-exclamation-triangle"></i> Advertencia sobre Intercambios
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p><strong>Blue Shopping no se responsabiliza del contacto y confirmación de los intercambios.</strong></p>
                <p>Evita perder clientes y elimina tu producto o disminuye el stock tras concluir un intercambio.</p>
                <p class="mb-0">Cualquier disgusto entre usuarios puede ser reportado a nuestro mail de contacto.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-warning" id="btnAceptarAdvertencia">
                    Entendido, continuar
                </button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const radios = document.querySelectorAll('input[name="tipo_venta"]');
    const precioContainer = document.getElementById('precio-container');
    const precioInput = document.getElementById('price');
    const form = document.getElementById('formProducto');
    let modalShown = false;
    
    // Manejo del campo precio según tipo de venta
    radios.forEach(radio => {
        radio.addEventListener('change', function() {
            if (this.value === 'intercambio') {
                precioContainer.style.opacity = '0.5';
                precioInput.readOnly = true;  // ← Cambiar aquí
                precioInput.value = '0';
            } else {
                precioContainer.style.opacity = '1';
                precioInput.readOnly = false;  // ← Y aquí
            }
        });
    });
    
    // Validar antes de enviar
    form.addEventListener('submit', function(e) {
        const tipoSeleccionado = document.querySelector('input[name="tipo_venta"]:checked').value;
        
        // Si incluye intercambio y no se mostró el modal
        if ((tipoSeleccionado === 'intercambio' || tipoSeleccionado === 'ambos') && !modalShown) {
            e.preventDefault();
            e.stopPropagation();
            
            // Mostrar modal
            const modalElement = document.getElementById('modalAdvertenciaIntercambio');
            const modal = new bootstrap.Modal(modalElement);
            modal.show();
            
            // Cuando acepte
            document.getElementById('btnAceptarAdvertencia').onclick = function() {
                modalShown = true;
                modal.hide();
                // Esperar a que se cierre el modal
                modalElement.addEventListener('hidden.bs.modal', function() {
                    form.submit();
                }, { once: true });
            };
        }
    });
});
</script>
{% endblock %}