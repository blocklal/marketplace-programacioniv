{% extends 'base.html' %}

{% block title %}Agregar producto{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <h1 class="my-4">Agregar nuevo producto</h1>
            
            <form method="post" enctype="multipart/form-data" id="formProducto">
                {% csrf_token %}
                
                <div class="mb-3">
                    <label for="name" class="form-label">Nombre</label>
                    <input type="text" class="form-control" id="name" name="name" required maxlength="50">
                </div>

                <div class="mb-3">
                    <label for="category" class="form-label">Categoría   (Si requerís una categoría nueva, contáctanos.)</label>
                    <select class="form-control" id="category" name="category" required>
                        <option value="">Selecciona una categoría</option>
                        {% for category in categories %}
                            <option value="{{ category.id }}">{{ category.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Subcategorías (Opcional)</label>
                    <div id="subcategory_checkboxes">
                        <div class="alert alert-light small mb-0 p-2">
                        Primero selecciona una categoría.
                        </div>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label for="description" class="form-label">Descripción</label>
                    <textarea class="form-control" id="description" name="description" rows="4"></textarea>
                </div>

                <div class="mb-4">
                    <label class="form-label d-block">
                        <strong>Tipo de transacción</strong>
                    </label>
                    <div class="card">
                        <div class="card-body">
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="radio" name="tipo_venta" 
                                        id="tipo_venta" value="venta" checked>
                                <label class="form-check-label" for="tipo_venta">
                                    <strong><i class="fas fa-dollar-sign text-success"></i> Solo venta</strong>
                                    <small class="d-block text-muted">El producto solo estará disponible para compra</small>
                                </label>
                            </div>
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="radio" name="tipo_venta" 
                                        id="tipo_intercambio" value="intercambio">
                                <label class="form-check-label" for="tipo_intercambio">
                                    <strong><i class="fas fa-exchange-alt text-info"></i> Solo intercambio</strong>
                                    <small class="d-block text-muted">El producto solo estará disponible para intercambio (no se mostrará el precio)</small>
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="tipo_venta" 
                                        id="tipo_ambos" value="ambos">
                                <label class="form-check-label" for="tipo_ambos">
                                    <strong><i class="fas fa-arrows-alt-h text-primary"></i> Venta o intercambio</strong>
                                    <small class="d-block text-muted">El producto estará disponible para ambas opciones</small>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mb-3" id="precio-container">
                    <label for="price" class="form-label">Precio</label>
                    <div class="input-group">
                        <span class="input-group-text">$</span>
                        <input type="number" class="form-control" id="price" name="price" 
                            step="0.01" value="0">
                    </div>
                    <small class="text-muted">Precio sugerido para venta o referencia</small>
                </div>

                <div class="mb-3">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="en_oferta" name="en_oferta">
                        <label class="form-check-label" for="en_oferta">
                            <strong><i class="fas fa-tag text-danger"></i> Producto en oferta</strong>
                        </label>
                    </div>
                </div>

                <div class="mb-3" id="descuento-container" style="display: none;">
                    <label for="porcentaje_descuento" class="form-label">Porcentaje de descuento</label>
                    <div class="input-group">
                        <input type="number" class="form-control" id="porcentaje_descuento" 
                            name="porcentaje_descuento" value="0" min="0" max="100">
                        <span class="input-group-text">%</span>
                    </div>
                    <small class="text-muted">Descuento del 0% al 100%</small>
                </div>

                <div class="mb-3">
                    <label for="stock" class="form-label">Stock</label>
                    <input type="number" class="form-control" id="stock" name="stock" value="1" required>
                </div>

                <div class="mb-3">
                    <label for="brand" class="form-label">Marca</label>
                    <input type="text" class="form-control" id="brand" name="brand" maxlength="50" value="Genérico">
                </div>

                <div class="mb-3">
                    <label for="image" class="form-label">Imagen</label>
                    <input type="file" class="form-control" id="image" name="image" accept="image/*">
                </div>

                <div class="d-flex gap-2">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Guardar Producto
                    </button>
                    <a href="{% url 'product_list' %}" class="btn btn-secondary">Cancelar</a>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="modalAdvertenciaIntercambio" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, #ffc107, #ff9800);">
                <h5 class="modal-title text-white">
                    <i class="fas fa-exclamation-triangle"></i> Advertencia sobre intercambios
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p><strong>Blue Shopping no se responsabiliza del contacto y confirmación de los intercambios.</strong></p>
                <p>Evita perder clientes y elimina tu producto o disminuye el stock tras concluir un intercambio.</p>
                <p class="mb-0">Cualquier disgusto entre usuarios puede ser reportado a nuestro mail de contacto.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-warning" id="btnAceptarAdvertencia">
                    Entendido, continuar
                </button>
            </div>
        </div>
    </div>
</div>

<script>

document.getElementById('category').addEventListener('change', function() {
  const categoryId = this.value;
  const container = document.getElementById('subcategory_checkboxes');

  if (!categoryId) {
    container.innerHTML = '<div class="alert alert-light small mb-0 p-2">Primero selecciona una categoría.</div>';
    return;
  }

  // Usamos tu endpoint existente
  fetch(`{% url 'ajax_load_subcategories' %}?category_id=${categoryId}`)

    .then(response => response.json())
    .then(data => {
      container.innerHTML = ""; // limpiar

      if (data.length === 0) {
        container.innerHTML = '<div class="alert alert-light small mb-0 p-2">No hay subcategorías para esta categoría.</div>';
      } else {
        data.forEach(subcat => {
          container.innerHTML += `
            <div class="form-check">
              <input class="form-check-input" type="checkbox" 
                     name="subcategories" id="subcat_${subcat.id}" value="${subcat.id}">
              <label class="form-check-label" for="subcat_${subcat.id}">
                ${subcat.name}
              </label>
            </div>
          `;
        });
      }
    })
    .catch(error => {
      console.error("Error cargando subcategorías:", error);
      container.innerHTML = '<div class="alert alert-danger">Error al cargar subcategorías.</div>';
    });
});


document.addEventListener('DOMContentLoaded', function() {
    const radios = document.querySelectorAll('input[name="tipo_venta"]');
    const precioContainer = document.getElementById('precio-container');
    const precioInput = document.getElementById('price');
    const form = document.getElementById('formProducto');
    const checkOferta = document.getElementById('en_oferta');
    const descuentoContainer = document.getElementById('descuento-container');
    let modalShown = false;

    radios.forEach(radio => {
        radio.addEventListener('change', function() {
            if (this.value === 'intercambio') {
                precioContainer.style.opacity = '0.5';
                precioInput.readOnly = true;
                precioInput.value = '0';
            } else {
                precioContainer.style.opacity = '1';
                precioInput.readOnly = false;
            }
        });
    });

    checkOferta.addEventListener('change', function() {
        if (this.checked) {
            descuentoContainer.style.display = 'block';
        } else {
            descuentoContainer.style.display = 'none';
            document.getElementById('porcentaje_descuento').value = '0';
        }
    });
    
    form.addEventListener('submit', function(e) {
        const tipoSeleccionado = document.querySelector('input[name="tipo_venta"]:checked').value;
        
        if ((tipoSeleccionado === 'intercambio' || tipoSeleccionado === 'ambos') && !modalShown) {
            e.preventDefault();
            e.stopPropagation();
            
            const modalElement = document.getElementById('modalAdvertenciaIntercambio');
            const modal = new bootstrap.Modal(modalElement);
            modal.show();
            
            document.getElementById('btnAceptarAdvertencia').onclick = function() {
                modalShown = true;
                modal.hide();
                modalElement.addEventListener('hidden.bs.modal', function() {
                    form.submit();
                }, { once: true });
            };
        }
    });
});
</script>
{% endblock %}